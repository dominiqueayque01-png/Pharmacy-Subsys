<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sales & Billing - Well Served Pharmacy</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: "#005a32",
                    secondary: "#d62828",
                    accent: "#8b5a2b",
                    "background-light": "#f1f5f9",
                    "background-dark": "#0f172a",
                    "surface-light": "#FFFFFF",
                    "surface-dark": "#1F2937",
                    "text-light": "#1F2937",
                    "text-dark": "#F9FAFB",
                    "subtext-light": "#6B7280",
                    "subtext-dark": "#9CA3AF",
                    "border-light": "#E5E7EB",
                    "border-dark": "#374151",
                    "success": "#22C55E",
                    "warning": "#F59E0B",
                    "danger": "#EF4444"
                },
                fontFamily: { display: ["Inter", "sans-serif"] }
            }
        }
    };
</script>
<style>
    

    .drag-region { -webkit-app-region: drag; }
    .no-drag { -webkit-app-region: no-drag; }

    /* ── FANCY NOTIFICATION DROPDOWN ── */
    @keyframes badge-pop { from { transform: scale(0); } to { transform: scale(1); } }
    #notificationBadge { animation: badge-pop 0.3s cubic-bezier(.34,1.56,.64,1); }

    .notif-dropdown {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        width: 370px;
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.14), 0 4px 12px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
        z-index: 1000;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-8px) scale(0.97);
        pointer-events: none;
        transition: opacity 0.22s ease, transform 0.22s cubic-bezier(.34,1.56,.64,1);
        transform-origin: top right;
    }
    .dark .notif-dropdown { background: #1F2937; border-color: #374151; }
    .notif-dropdown.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

    .notif-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 18px 14px; border-bottom: 1px solid #f0f0f0; }
    .dark .notif-header { border-color: #374151; }
    .notif-header h3 { font-size: 15px; font-weight: 700; color: #111827; }
    .dark .notif-header h3 { color: #F9FAFB; }
    .notif-header-meta { display: flex; align-items: center; gap: 10px; }
    .unread-count-pill { background: #005a32; color: #fff; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 99px; }
    .mark-all-btn { font-size: 11px; color: #005a32; font-weight: 600; background: none; border: none; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background 0.15s; }
    .mark-all-btn:hover { background: #f0fdf4; }

    .notif-tabs { display: flex; gap: 4px; padding: 10px 14px; background: #fafafa; border-bottom: 1px solid #f0f0f0; }
    .dark .notif-tabs { background: #111827; border-color: #374151; }
    .notif-tab-btn { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 99px; border: 1px solid transparent; cursor: pointer; background: none; color: #6b7280; transition: all 0.15s; }
    .notif-tab-btn.active { background: #005a32; color: #fff; border-color: #005a32; }
    .notif-tab-btn:not(.active):hover { background: #f3f4f6; border-color: #e5e7eb; color: #374151; }

    .notif-list { max-height: 360px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #e5e7eb transparent; }
    .notif-list::-webkit-scrollbar { width: 4px; }
    .notif-list::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 2px; }

    .notif-item { display: flex; gap: 12px; align-items: flex-start; padding: 13px 16px; border-bottom: 1px solid #f5f5f5; cursor: pointer; position: relative; transition: background 0.15s; }
    .dark .notif-item { border-color: #374151; }
    .notif-item:last-child { border-bottom: none; }
    .notif-item:hover { background: #f9fafb; }
    .dark .notif-item:hover { background: #111827; }
    .notif-item.unread { background: #ffffff; }
    .dark .notif-item.unread { background: #1F2937; }
    .notif-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; border-radius: 0 2px 2px 0; }
    .notif-item.critical::before { background: #EF4444; }
    .notif-item.expiry::before   { background: #8b5a2b; }
    .notif-item.shortage::before { background: #358E83; }

    .notif-icon-wrap { flex-shrink: 0; width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .notif-icon-wrap .material-icons { font-size: 20px; }
    .icon-critical { background: #fef2f2; } .icon-critical .material-icons { color: #EF4444; }
    .icon-expiry   { background: #fdf6ec; } .icon-expiry   .material-icons { color: #8b5a2b; }
    .icon-shortage { background: #f0fdfa; } .icon-shortage .material-icons { color: #358E83; }

    .notif-body { flex: 1; min-width: 0; }
    .notif-title { font-size: 13px; font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dark .notif-title { color: #F9FAFB; }
    .notif-desc  { font-size: 12px; color: #6b7280; margin-top: 2px; line-height: 1.4; }
    .notif-time  { font-size: 10px; color: #9ca3af; margin-top: 6px; }
    .notif-action { margin-top: 8px; }
    .notif-action-btn { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 700; padding: 5px 12px; border-radius: 6px; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 0.04em; transition: opacity 0.15s, transform 0.1s; }
    .notif-action-btn:active { transform: scale(0.96); }
    .notif-action-btn:hover  { opacity: 0.88; }
    .btn-critical { background: #EF4444; color: #fff; }
    .btn-expiry   { background: #8b5a2b; color: #fff; }
    .btn-shortage { background: #005a32; color: #fff; }

    .unread-dot { flex-shrink: 0; width: 7px; height: 7px; border-radius: 50%; background: #005a32; margin-top: 5px; }
    .notif-empty { padding: 40px 20px; text-align: center; color: #9ca3af; }
    .notif-empty .material-icons { font-size: 40px; margin-bottom: 8px; display: block; }
    .notif-empty p { font-size: 13px; }
    .notif-footer { border-top: 1px solid #f0f0f0; padding: 12px 18px; display: flex; align-items: center; justify-content: space-between; }
    .dark .notif-footer { border-color: #374151; }
    .view-all-link { font-size: 12px; font-weight: 600; color: #005a32; text-decoration: none; display: flex; align-items: center; gap: 4px; }
    .view-all-link:hover { text-decoration: underline; }
    .view-all-link .material-icons { font-size: 14px; }
    /* ── END NOTIFICATION STYLES ── */

    .hidden { display: none !important; }
    .animate-spin-slow { animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Status Badges */
    .status-badge { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
    .status-Paid    { background-color: rgba(34, 197, 94, 0.1); color: rgb(22, 163, 74); }
    .status-Pending { background-color: rgba(245, 158, 11, 0.1); color: rgb(180, 83, 9); }
    .status-Failed  { background-color: rgba(239, 68, 68, 0.1); color: rgb(185, 28, 28); }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-display">


<!--Titlebar-->
<div id="title-bar" class="drag-region fixed top-0 left-0 w-full h-8 bg-white flex justify-between items-stretch z-40 border-b border-gray-200 select-none">
    <div class="flex items-center pl-4 gap-2 text-gray-600">
        <span class="text-xs font-semibold">IHMS Pharmacy</span>
    </div>
    <div class="no-drag flex items-center relative z-50"> 
        <button id="min-btn" class="h-full w-12 flex justify-center items-center hover:bg-gray-200 transition-colors duration-200">
            <span class="material-icons-outlined text-sm text-gray-600">remove</span>
        </button>
        <button id="max-btn" class="h-full w-12 flex justify-center items-center hover:bg-gray-200 transition-colors duration-200">
            <span class="material-icons-outlined text-sm text-gray-600">crop_square</span>
        </button>
        <button id="close-btn" class="h-full w-12 flex justify-center items-center hover:bg-red-500 hover:text-white transition-colors duration-200 group">
            <span class="material-icons-outlined text-sm text-gray-600 group-hover:text-white">close</span>
        </button>
    </div>
</div>

    <div class="flex h-screen pt-8">
    
    <aside class="w-64 bg-surface-light dark:bg-surface-dark flex flex-col border-r border-border-light dark:border-border-dark">
        <div class="h-16 flex items-center px-6 border-b border-border-light dark:border-border-dark">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white font-bold text-lg border border-slate-100 dark:border-slate-700 shadow-sm">WS</div>
                <div>
                    <h1 class="font-bold text-primary dark:text-green-400 leading-tight">Well Served</h1>
                    <p class="text-[10px] uppercase tracking-wider text-accent dark:text-amber-600 font-semibold">Since 1994</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <div class="px-2 text-sm font-semibold text-subtext-light dark:text-subtext-dark">Pharmacy</div>
            <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md" href="dashboard.html">
                <span class="material-icons mr-3">dashboard</span> Dashboard
            </a>
            <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md" href="inventory.html">
                <span class="material-icons mr-3">inventory_2</span> Inventory
            </a>
            <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md" href="patient_records.html">
                <span class="material-icons mr-3">folder_shared</span> Patient Records
            </a>
            <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md" href="supplier.html">
                <span class="material-icons mr-3">local_shipping</span> Suppliers
            </a>
            <a class="flex items-center px-4 py-2 bg-primary/10 text-primary rounded-md font-semibold" href="billing.html">
                <span class="material-icons mr-3">point_of_sale</span> Sales &amp; Billing
            </a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- ── HEADER (matches dashboard/inventory) ── -->
        <header class="h-16 bg-surface-light dark:bg-surface-dark flex items-center justify-between px-6 border-b border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-2">
                <button onclick="confirmBackToHMS(event)" class="flex items-center gap-1 text-sm text-subtext-light hover:text-primary">
                    <span class="material-icons">arrow_back_ios_new</span> Back to IHMS
                </button>
            </div>
            <div class="flex items-center gap-4">
                <!-- Fancy Notification Bell -->
                <div class="relative">
                    <button id="notificationBtn"
                        class="relative text-subtext-light dark:text-subtext-dark hover:text-text-light dark:hover:text-text-dark p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="material-icons text-2xl">notifications</span>
                        <span id="notificationBadge"
                            class="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center font-bold"
                            style="display:none;">0</span>
                    </button>
                    <div id="notificationDropdown" class="notif-dropdown">
                        <div class="notif-header">
                            <h3>Notifications</h3>
                            <div class="notif-header-meta">
                                <span class="unread-count-pill" id="unreadPill">Loading...</span>
                                <button class="mark-all-btn" onclick="markAllRead()">Mark all read</button>
                            </div>
                        </div>
                        <div class="notif-tabs">
                            <button class="notif-tab-btn active" onclick="filterNotifTab(this,'all')">All</button>
                            <button class="notif-tab-btn" onclick="filterNotifTab(this,'critical')">Critical</button>
                            <button class="notif-tab-btn" onclick="filterNotifTab(this,'expiry')">Expiry</button>
                            <button class="notif-tab-btn" onclick="filterNotifTab(this,'shortage')">Stock</button>
                        </div>
                        <div class="notif-list" id="notifList">
                            <div style="padding:30px 20px;text-align:center;color:#9ca3af;">
                                <span class="material-icons" style="font-size:32px;display:block;margin:0 auto 8px;">hourglass_empty</span>
                                <p style="font-size:12px;">Loading alerts...</p>
                            </div>
                        </div>
                        <div class="notif-footer">
                            <a href="inventory.html" class="view-all-link">
                                View inventory <span class="material-icons">arrow_forward</span>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Profile avatar -->
                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold">PH</div>
                <!-- Logout button -->
                <button onclick="logoutUser()" 
                    class="flex items-center gap-1 bg-primary text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-primary/90 transition-colors">
                    <span class="material-icons text-sm">logout</span>
                    Logout
                </button>
            </div>
        </header>

        <div class="flex-1 p-8 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-text-light dark:text-text-dark">Sales & Billing Records</h1>
                    <p class="text-subtext-light dark:text-subtext-dark mt-1">Track sales transactions auto-linked to billing system</p>
                </div>
            </div>

            <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex items-center space-x-4 mb-6">
                <div class="relative flex-1">
                    <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-subtext-light dark:text-subtext-dark">search</span>
                    <input id="tableSearchInput" oninput="billingManager.handleSearch(this.value)" class="w-full bg-background-light dark:bg-background-dark border-none rounded-lg pl-10 pr-4 py-2.5 text-sm focus:ring-primary focus:border-primary text-text-light dark:text-text-dark" placeholder="Search by Patient Name or ID..." type="text"/>
                </div>
                
                <select id="statusFilter" onchange="billingManager.handleFilter(this.value)" class="px-4 py-2.5 text-sm font-medium border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-primary/5 dark:hover:bg-primary/20 transition-colors bg-surface-light dark:bg-surface-dark focus:ring-primary text-text-light dark:text-text-dark">
                    <option value="all">All Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>

            <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-slate-200 dark:border-slate-800">
                <h2 class="text-xl font-semibold text-text-light dark:text-text-dark mb-4">Sales Transactions</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-subtext-light dark:text-subtext-dark uppercase bg-gray-50 dark:bg-gray-700/50">
                            <tr>
                                <th class="px-6 py-3 rounded-l-lg cursor-pointer">Date</th>
                                <th class="px-6 py-3 cursor-pointer">Patient</th>
                                <th class="px-6 py-3 cursor-pointer">Medicine(s)</th>
                                <th class="px-6 py-3 cursor-pointer">Amount</th>
                                <th class="px-6 py-3 cursor-pointer">Payment Status</th>
                                <th class="px-6 py-3 cursor-pointer text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="noResults" class="hidden text-center py-12 text-subtext-light dark:text-subtext-dark">
                    <span class="material-icons text-5xl mb-2 opacity-50">search_off</span>
                    <p>No transactions found matching your criteria</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const API_BASE_URL = 'http://localhost:5001';

    // ══════════════════════════════════════════════════════════
    // FANCY NOTIFICATION BELL — live from /api/inventory
    // ══════════════════════════════════════════════════════════
    let notifData         = [];
    let activeNotifFilter = 'all';

    function getNotifToken() {
        const direct = sessionStorage.getItem('token');
        if (direct) return direct;
        const userInfo = sessionStorage.getItem('userInfo');
        if (userInfo) {
            try { return JSON.parse(userInfo).token || null; } catch(e) {}
        }
        return null;
    }

    function generateAlertsFromInventory(inventory) {
        const alerts     = [];
        const today      = new Date();
        const thirtyDays = new Date();
        thirtyDays.setDate(today.getDate() + 30);

        inventory.forEach((item, idx) => {
            const medName = item.medicine?.name || item.name || 'Unknown Medicine';

            if (item.expiryDate) {
                const expiry = new Date(item.expiryDate);
                if (expiry < today) {
                    alerts.push({
                        id: `exp-${item._id || idx}`, type: 'expiry', unread: true,
                        medicineName: medName,
                        title: 'Medicine Expired',
                        desc:  `${medName} expired on ${expiry.toLocaleDateString('en-PH')}.`,
                        time:  'Needs immediate attention',
                        actionLabel: 'View Inventory', actionClass: 'btn-expiry',
                        icon: 'event_busy', iconClass: 'icon-expiry'
                    });
                } else if (expiry <= thirtyDays) {
                    const d = Math.ceil((expiry - today) / 864e5);
                    alerts.push({
                        id: `exp-${item._id || idx}`, type: 'expiry', unread: true,
                        medicineName: medName,
                        title: 'Expiring Soon',
                        desc:  `${medName} expires in ${d} day${d === 1 ? '' : 's'}.`,
                        time:  `${d} days left`,
                        actionLabel: 'View Inventory', actionClass: 'btn-expiry',
                        icon: 'schedule', iconClass: 'icon-expiry'
                    });
                }
            }

            const qty      = parseInt(item.quantity || 0);
            const minStock = parseInt(item.minStockLevel || 10);
            const isExpired = new Date(item.expiryDate) < today;

            if (!isExpired && qty === 0) {
                alerts.push({
                    id: `stk-${item._id || idx}`, type: 'critical', unread: true,
                    medicineName: medName,
                    title: 'Critical: Out of Stock',
                    desc:  `${medName} is completely out of stock.`,
                    time:  'Immediate action required',
                    actionLabel: 'View Inventory', actionClass: 'btn-critical',
                    icon: 'warning', iconClass: 'icon-critical'
                });
            } else if (!isExpired && qty <= minStock) {
                alerts.push({
                    id: `stk-${item._id || idx}`, type: 'shortage', unread: true,
                    medicineName: medName,
                    title: 'Low Stock Alert',
                    desc:  `${medName} — only ${qty} unit${qty === 1 ? '' : 's'} remaining (min: ${minStock}).`,
                    time:  'Reorder soon',
                    actionLabel: 'View Inventory', actionClass: 'btn-shortage',
                    icon: 'inventory_2', iconClass: 'icon-shortage'
                });
            }
        });

        const order = { critical: 0, expiry: 1, shortage: 2 };
        alerts.sort((a, b) => (order[a.type] ?? 9) - (order[b.type] ?? 9));
        return alerts;
    }

    function renderNotifications() {
        const list     = document.getElementById('notifList');
        const filtered = activeNotifFilter === 'all'
            ? notifData
            : notifData.filter(n => n.type === activeNotifFilter);

        if (!filtered.length) {
            const msg = activeNotifFilter === 'all' ? 'All clear — no alerts right now!' : 'No notifications in this category.';
            list.innerHTML = '<div class="notif-empty"><span class="material-icons">notifications_none</span><p>' + msg + '</p></div>';
            updateNotifBadge();
            return;
        }

        list.innerHTML = filtered.map(n => `
            <div class="notif-item ${n.type} ${n.unread ? 'unread' : ''}" id="notif-${n.id}" onclick="markNotifRead('${n.id}')">
                <div class="notif-icon-wrap ${n.iconClass}"><span class="material-icons">${n.icon}</span></div>
                <div class="notif-body">
                    <div class="notif-title">${n.title}</div>
                    <div class="notif-desc">${n.desc}</div>
                    <div class="notif-time">${n.time}</div>
                    <div class="notif-action">
                        <button class="notif-action-btn ${n.actionClass}" onclick="handleNotifAction(event,'${n.id}')">${n.actionLabel}</button>
                    </div>
                </div>
                ${n.unread ? '<div class="unread-dot"></div>' : ''}
            </div>`).join('');

        updateNotifBadge();
    }

    function updateNotifBadge() {
        const count = notifData.filter(n => n.unread).length;
        const badge = document.getElementById('notificationBadge');
        const pill  = document.getElementById('unreadPill');
        if (badge) { badge.textContent = count; badge.style.display = count > 0 ? 'flex' : 'none'; }
        if (pill)  pill.textContent = count > 0 ? `${count} new` : 'All clear';
    }

    function markNotifRead(id) {
        const n = notifData.find(n => n.id === id);
        if (n) { n.unread = false; renderNotifications(); }
    }

    function markAllRead() {
        notifData.forEach(n => n.unread = false);
        renderNotifications();
    }

    function handleNotifAction(event, id) {
        event.stopPropagation();
        markNotifRead(id);
        window.location.href = 'inventory.html';
    }

    function filterNotifTab(btn, filter) {
        document.querySelectorAll('.notif-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeNotifFilter = filter;
        renderNotifications();
    }

    async function refreshNotifications() {
        const token = getNotifToken();
        if (!token) return;
        try {
            const res = await fetch(`${API_BASE_URL}/api/inventory`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const raw       = await res.json();
            const inventory = Array.isArray(raw) ? raw : (raw.medicines || raw.data || []);
            const previouslyRead = new Set(notifData.filter(n => !n.unread).map(n => n.id));
            notifData = generateAlertsFromInventory(inventory).slice(0, 15);
            notifData.forEach(n => { if (previouslyRead.has(n.id)) n.unread = false; });
            renderNotifications();
        } catch (e) {
            console.warn('Notification fetch failed:', e);
            if (!notifData.length) {
                const list = document.getElementById('notifList');
                if (list) list.innerHTML = `<div class="notif-empty"><span class="material-icons">cloud_off</span><p>Could not load alerts.</p></div>`;
            }
        }
    }
    // ══ END FANCY NOTIFICATION SYSTEM ══

    class BillingManager {
        constructor() {
            this.salesData = [];
            this.init();
        }

        async init() {
            if(!this.getToken()) {
                window.location.href = '../../html/login.html';
                return;
            }
            await this.fetchSales();
        }

        getToken() {
            const userInfo = sessionStorage.getItem('userInfo');
            return userInfo ? JSON.parse(userInfo).token : null;
        }

        async fetchSales() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/sales`, {
                    headers: { 'Authorization': `Bearer ${this.getToken()}` }
                });
                if(res.ok) {
                    let data = await res.json();
                    
                    // --- SORTING FIX: FORCE LATEST DATE FIRST ---
                    data.sort((a, b) => {
                        const dateA = new Date(a.date || a.createdAt);
                        const dateB = new Date(b.date || b.createdAt);
                        return dateB - dateA; 
                    });
                    // --------------------------------------------

                    this.salesData = data;
                    this.renderTable(this.salesData);
                }
            } catch (err) {
                console.error("Fetch Error:", err);
            }
        }

        async syncWithBilling() {
            const btn = document.getElementById('syncBtn');
            const icon = document.getElementById('syncIcon');
            const staticIcon = document.getElementById('staticSyncIcon');
            
            btn.disabled = true;
            btn.classList.add('opacity-75');
            icon.style.display = 'inline-block';
            staticIcon.style.display = 'none';

            try {
                const res = await fetch(`${API_BASE_URL}/api/sales/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${this.getToken()}` }
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    Swal.fire({
                        title: 'Sync Complete',
                        text: result.message + (result.updated > 0 ? ` (${result.updated} updated)` : ''),
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false,
                        confirmButtonColor: '#005a32'
                    });
                    await this.fetchSales();
                } else {
                    Swal.fire('Sync Failed', result.message, 'error');
                }

            } catch (err) {
                Swal.fire('Error', 'Could not connect to server', 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                icon.style.display = 'none';
                staticIcon.style.display = 'inline-block';
            }
        }

        updateStats() {
            const totalRevenue = this.salesData
                .filter(s => s.paymentStatus === 'Paid')
                .reduce((acc, curr) => acc + curr.totalAmount, 0);
            
            const today = new Date().toDateString();
            const todaysSales = this.salesData
                .filter(s => new Date(s.date).toDateString() === today && s.paymentStatus === 'Paid')
                .reduce((acc, curr) => acc + curr.totalAmount, 0);

            document.getElementById('totalTransactions').textContent = this.salesData.length;
            document.getElementById('totalRevenue').textContent = `₱${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('todaysSales').textContent = `₱${todaysSales.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        }

        renderTable(data) {
            const tbody = document.getElementById('transactionsTableBody');
            const noResults = document.getElementById('noResults');

            if (!data || data.length === 0) {
                tbody.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            tbody.innerHTML = data.map(sale => {
                // 1. Status Badge
                const statusClass = `status-${sale.paymentStatus || 'Pending'}`;
                
                // 2. Date Fix
                let dateDisplay = "N/A";
                const rawDate = sale.date || sale.createdAt;
                if (rawDate) {
                    const d = new Date(rawDate);
                    if (!isNaN(d.getTime())) {
                        dateDisplay = d.toLocaleDateString();
                    }
                }

                // 3. Patient Info
                const pName = sale.patientName || "Walk-in";
                let pIdDisplay = "Guest";
                if (sale.patient && sale.patient.patientId) {
                     pIdDisplay = sale.patient.patientId; 
                } else if (typeof sale.patient === 'string') {
                     pIdDisplay = sale.patient.substring(0, 6).toUpperCase();
                }

                // 4. Medicine Dropdown Logic
                let medicineHtml = '<span class="text-gray-400 italic">No items</span>';
                
                if (sale.items && sale.items.length > 0) {
                    const options = sale.items.map(item => {
                        let name = item.name;
                        if ((!name || name === "Unknown") && item.medicine && item.medicine.name) {
                            name = item.medicine.name;
                        }
                        const finalName = name || "Unknown Medicine";
                        return `<option>${finalName} (x${item.quantity})</option>`;
                    }).join('');

                    medicineHtml = `
                        <select class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            ${options}
                        </select>
                    `;
                }

                // 5. Amount
                const amount = sale.totalAmount !== undefined ? sale.totalAmount : 0;

                return `
                <tr class="border-b border-slate-200 dark:border-slate-700 hover:bg-gray-50/50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="px-6 py-4 text-subtext-light dark:text-subtext-dark whitespace-nowrap">
                        ${dateDisplay}
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-text-light dark:text-text-dark">${pName}</div>
                        <div class="text-xs text-subtext-light dark:text-subtext-dark bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded w-fit mt-1">${pIdDisplay}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="w-64">${medicineHtml}</div>
                    </td>
                    <td class="px-6 py-4 font-bold text-text-light dark:text-text-dark">
                        ₱${amount.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${statusClass}">
                            ${sale.paymentStatus || 'Pending'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="billingManager.viewDetails('${sale._id}')" class="text-primary hover:text-primary/80 font-medium text-sm flex items-center justify-center gap-1 mx-auto">
                            <span class="material-icons text-base">receipt</span> View
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        handleSearch(val) {
            const lower = val.toLowerCase();
            const filtered = this.salesData.filter(s => 
                (s.patientName && s.patientName.toLowerCase().includes(lower)) ||
                s._id.includes(lower) ||
                s.items.some(i => i.name.toLowerCase().includes(lower))
            );
            this.renderTable(filtered);
        }

        handleFilter(status) {
            if(status === 'all') this.renderTable(this.salesData);
            else {
                const filtered = this.salesData.filter(s => s.paymentStatus === status);
                this.renderTable(filtered);
            }
        }

        viewDetails(id) {
            const sale = this.salesData.find(s => s._id === id);
            if(!sale) return;
            
            const itemsHtml = sale.items.map(i => 
                `<div class="flex justify-between text-sm py-1 border-b border-gray-100 last:border-0">
                    <span>${i.name} <span class="text-gray-500 text-xs">x${i.quantity}</span></span>
                    <span>₱${(i.priceAtSale * i.quantity).toFixed(2)}</span>
                </div>`
            ).join('');

            Swal.fire({
                title: 'Transaction Details',
                html: `
                    <div class="text-left space-y-3 mb-2">
                        <div class="bg-gray-50 p-3 rounded text-sm">
                            <p><strong>Ref ID:</strong> ${sale._id}</p>
                            <p><strong>Date:</strong> ${new Date(sale.date).toLocaleString()}</p>
                            <p><strong>Patient:</strong> ${sale.patientName || 'Walk-in'}</p>
                            <p><strong>Status:</strong> <span class="font-bold">${sale.paymentStatus}</span></p>
                        </div>
                        <div class="mt-2">
                            <p class="font-semibold text-sm mb-1">Items Purchased:</p>
                            ${itemsHtml}
                        </div>
                        <div class="border-t pt-3 mt-2 flex justify-between font-bold text-lg text-primary">
                            <span>Total Amount</span>
                            <span>₱${sale.totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>
                `,
                confirmButtonColor: '#005a32'
            });
        }
    }

    function confirmBackToHMS(event) {
        event.preventDefault();
        Swal.fire({
            title: "Leave Sales & Billing?",
            text: "Return to Integrated Healthcare Management System?",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#005a32",
            confirmButtonText: "Yes, go back"
        }).then((result) => {
            if (result.isConfirmed) window.location.href = 'index.html';
        });
    }

    function logoutUser() {
        Swal.fire({
            title: "Logout?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#005a32",
            confirmButtonText: "Yes, logout"
        }).then((result) => {
            if (result.isConfirmed) {
                sessionStorage.removeItem('userInfo');
                sessionStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        });
    }

    const billingManager = new BillingManager();
    window.billingManager = billingManager;

    document.addEventListener('DOMContentLoaded', function() {
        // Dark mode
        const isDarkMode = sessionStorage.getItem('darkMode') === 'true';
        document.documentElement.classList.toggle('dark', isDarkMode);

        // Wire up fancy notification bell
        const btn      = document.getElementById('notificationBtn');
        const dropdown = document.getElementById('notificationDropdown');
        if (btn && dropdown) {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
                if (dropdown.classList.contains('open')) refreshNotifications();
            });
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && e.target !== btn) dropdown.classList.remove('open');
            });
            dropdown.addEventListener('click', e => e.stopPropagation());
            setTimeout(refreshNotifications, 1000);
            setInterval(refreshNotifications, 60000);
        }
    });
</script>
<script src="../js/windowcontrollerbtn.js"></script>
</body>
</html>